---
 - name: Permissão de pasta
   file: path={{ configs.vm_path }} state=directory owner=www-data group=www-data mode=0775
   become: yes
   become_method: sudo

 - name: Permissão de uso da Storage
   file: path={{ configs.vm_path }}/storage state=directory mode=0777
   become: yes
   become_method: sudo

 - name: Check Env
   stat: path={{ configs.vm_path }}/.env
   register: env_file

 - name: Copia arquivo Env
   become: yes
   become_method: sudo
   shell: echo "APP_ENV=local" > {{ configs.vm_path }}/.env \
          echo "APP_KEY=" >> {{ configs.vm_path }}/.env \
          echo "APP_DEBUG=true" >> {{ configs.vm_path }}/.env \
          echo "APP_LOG_LEVEL=debug" >> {{ configs.vm_path }}/.env \
          echo "APP_URL={{ configs.vm_url }}" >> {{ configs.vm_path }}/.env \
          echo "" >> {{ configs.vm_path }}/.env \
          echo "DB_CONNECTION=mysql" >> {{ configs.vm_path }}/.env \
          echo "DB_HOST=127.0.0.1" >> {{ configs.vm_path }}/.env \
          echo "DB_PORT=3306" >> {{ configs.vm_path }}/.env \
          echo "DB_DATABASE={{ mysql.database }}" >> {{ configs.vm_path }}/.env \
          echo "DB_USERNAME={{ mysql.user }}" >> {{ configs.vm_path }}/.env \
          echo "DB_PASSWORD={{ mysql.password }}" >> {{ configs.vm_path }}/.env \
          echo "" >> {{ configs.vm_path }}/.env \
          echo "BROADCAST_DRIVER=log" >> {{ configs.vm_path }}/.env \
          echo "CACHE_DRIVER=file" >> {{ configs.vm_path }}/.env \
          echo "SESSION_DRIVER=file" >> {{ configs.vm_path }}/.env \
          echo "QUEUE_DRIVER=sync" >> {{ configs.vm_path }}/.env \
          echo "" >> {{ configs.vm_path }}/.env \
          echo "REDIS_HOST=127.0.0.1" >> {{ configs.vm_path }}/.env \
          echo "REDIS_PASSWORD=null" >> {{ configs.vm_path }}/.env \
          echo "REDIS_PORT=6379" >> {{ configs.vm_path }}/.env \
          echo "" >> {{ configs.vm_path }}/.env \
          echo "MAIL_DRIVER=smtp" >> {{ configs.vm_path }}/.env \
          echo "MAIL_HOST=mailtrap.io" >> {{ configs.vm_path }}/.env \
          echo "MAIL_PORT=2525" >> {{ configs.vm_path }}/.env \
          echo "MAIL_USERNAME=null" >> {{ configs.vm_path }}/.env \
          echo "MAIL_PASSWORD=null" >> {{ configs.vm_path }}/.env \
          echo "MAIL_ENCRYPTION=null" >> {{ configs.vm_path }}/.env \
          echo "" >> {{ configs.vm_path }}/.env \
          echo "PUSHER_APP_ID=" >> {{ configs.vm_path }}/.env \
          echo "PUSHER_KEY=" >> {{ configs.vm_path }}/.env \
          echo "PUSHER_SECRET=" >> {{ configs.vm_path }}/.env \
          echo "" >> {{ configs.vm_path }}/.env
   when: env_file.stat.exists == False

 - name: Permissão de uso da Storage
   file: path={{ configs.vm_path }}/bootstrap/cache/ state=directory mode=0777
   become: yes
   become_method: sudo

 - name: Install Composer on Project
   composer: command=install working_dir={{ configs.vm_path }}

 - name: Install Migrations and seeds
   shell: php artisan migrate --seed
   args:
    chdir: "{{ configs.vm_path }}"